<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>॥ श्री रामायणम् ॥ - The Ramayana RPG</title>
    <style>
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px #fcd34d, 0 0 20px #fcd34d; }
            50% { text-shadow: 0 0 20px #fcd34d, 0 0 40px #fcd34d; }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent 50%, rgba(0, 255, 0, 0.03) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(0, 255, 0, 0.1);
            animation: scanline 8s linear infinite;
            pointer-events: none;
            z-index: 9999;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .pixel-border {
            border: 4px solid #00ff00;
            padding: 20px;
            background: rgba(0, 20, 0, 0.9);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .main-menu {
            text-align: center;
            padding: 40px 20px;
        }

        .title {
            font-size: 3em;
            color: #fcd34d;
            animation: glow 2s ease-in-out infinite;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 5px;
        }

        .subtitle {
            font-size: 1.5em;
            color: #00ff00;
            margin-bottom: 40px;
            text-shadow: 0 0 10px #00ff00;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'Courier New', monospace;
            background: #001100;
            color: #00ff00;
            border: 3px solid #00ff00;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .btn:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
            transform: scale(1.05);
        }

        .btn-secondary {
            background: #110011;
            color: #ff00ff;
            border-color: #ff00ff;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }

        .btn-secondary:hover {
            background: #ff00ff;
            color: #000;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
        }

        .character-selection {
            text-align: center;
            padding: 20px;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .character-card {
            background: rgba(0, 20, 0, 0.9);
            border: 3px solid #00ff00;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            border-color: #fcd34d;
            box-shadow: 0 0 30px rgba(252, 211, 77, 0.5);
            transform: translateY(-5px);
        }

        .character-name {
            font-size: 1.8em;
            color: #fcd34d;
            margin-bottom: 10px;
        }

        .character-desc {
            color: #00ff00;
            margin: 15px 0;
            line-height: 1.6;
        }

        .character-stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #00ff00;
            text-align: left;
        }

        .stat-line {
            margin: 5px 0;
            color: #00ff00;
        }

        .game-screen {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .game-screen {
                grid-template-columns: 1fr;
            }
        }

        .game-header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            background: rgba(0, 20, 0, 0.9);
            border: 3px solid #00ff00;
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 2em;
            color: #fcd34d;
            animation: glow 2s ease-in-out infinite;
        }

        .location-display {
            font-size: 1.3em;
            color: #00ff00;
            margin-top: 10px;
            text-shadow: 0 0 10px #00ff00;
        }

        .panel {
            background: rgba(0, 20, 0, 0.9);
            border: 3px solid #00ff00;
            padding: 20px;
            height: fit-content;
        }

        .panel-title {
            color: #fcd34d;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 0 0 10px #fcd34d;
        }

        .resource {
            margin: 15px 0;
        }

        .resource-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: #00ff00;
        }

        .resource-bar {
            height: 20px;
            background: #001100;
            border: 2px solid #00ff00;
            position: relative;
            overflow: hidden;
        }

        .resource-fill {
            height: 100%;
            transition: width 0.5s;
        }

        .energy-fill {
            background: linear-gradient(90deg, #00ff00, #00cc00);
        }

        .favor-fill {
            background: linear-gradient(90deg, #00ffff, #0088ff);
        }

        .tapas-fill {
            background: linear-gradient(90deg, #ff00ff, #cc00ff);
        }

        .low-resource {
            animation: glow 1s ease-in-out infinite;
            color: #ff0000 !important;
        }

        .story-panel {
            background: rgba(0, 20, 0, 0.9);
            border: 3px solid #00ff00;
            padding: 30px;
            min-height: 500px;
        }

        .chapter-title {
            font-size: 1.8em;
            color: #fcd34d;
            margin-bottom: 20px;
            text-align: center;
            animation: glow 2s ease-in-out infinite;
        }

        .verse {
            background: rgba(255, 0, 255, 0.1);
            border-left: 4px solid #ff00ff;
            padding: 15px;
            margin: 20px 0;
            font-style: italic;
        }

        .verse-sanskrit {
            color: #fcd34d;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .verse-translation {
            color: #00ff00;
        }

        .story-text {
            color: #00ff00;
            line-height: 1.8;
            margin: 20px 0;
        }

        .sage-teaching {
            background: rgba(0, 255, 255, 0.1);
            border: 3px solid #00ffff;
            padding: 20px;
            margin: 20px 0;
        }

        .sage-teaching h3 {
            color: #00ffff;
            margin-bottom: 10px;
        }

        .choices {
            margin-top: 30px;
        }

        .choice-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #00ff00;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }

        .choice-btn:hover:not(:disabled) {
            background: rgba(0, 255, 0, 0.2);
            border-color: #fcd34d;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            transform: translateX(10px);
        }

        .choice-btn:disabled {
            border-color: #ff0000;
            color: #ff0000;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .battle-screen {
            background: rgba(139, 0, 0, 0.2);
            border: 3px solid #ff0000;
            padding: 30px;
        }

        .battle-title {
            font-size: 2em;
            color: #ff0000;
            text-align: center;
            margin-bottom: 20px;
            animation: glow 1s ease-in-out infinite;
        }

        .battle-canvas {
            border: 3px solid #ff0000;
            background: linear-gradient(45deg, #001100, #000000);
            margin: 20px auto;
            display: block;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
        }

        .weapon-selection {
            background: rgba(139, 0, 0, 0.2);
            border: 3px solid #ff00ff;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .weapon-selection h3 {
            color: #ff00ff;
            margin-bottom: 15px;
        }

        .weapon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .astra-btn {
            padding: 10px 15px;
            margin: 5px;
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #fcd34d;
            color: #fcd34d;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .astra-btn:hover {
            background: rgba(252, 211, 77, 0.2);
            box-shadow: 0 0 15px rgba(252, 211, 77, 0.5);
            transform: scale(1.1);
        }

        .astra-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .defend-btn {
            padding: 10px 15px;
            margin: 5px;
            background: rgba(0, 20, 0, 0.9);
            border: 2px solid #00ffff;
            color: #00ffff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .defend-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .battle-log {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .log-entry {
            margin: 8px 0;
            padding: 5px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }

        .battle-result {
            background: rgba(0, 255, 0, 0.1);
            border: 3px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1em;
        }

        .feedback {
            background: rgba(0, 255, 255, 0.1);
            border: 3px solid #00ffff;
            padding: 20px;
            margin: 20px 0;
        }

        .feedback h3 {
            color: #00ffff;
            margin-bottom: 15px;
        }

        .stat-change {
            margin: 5px 0;
            padding: 5px 10px;
        }

        .stat-positive {
            color: #00ff00;
        }

        .stat-negative {
            color: #ff0000;
        }

        .death-screen {
            background: rgba(139, 0, 0, 0.3);
            border: 4px solid #ff0000;
            padding: 40px;
            text-align: center;
        }

        .death-screen h2 {
            color: #ff0000;
            font-size: 2.5em;
            margin-bottom: 20px;
            animation: glow 1s ease-in-out infinite;
        }

        .lesson {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            line-height: 1.8;
        }

        .rest-screen {
            background: rgba(0, 255, 255, 0.1);
            border: 3px solid #00ffff;
            padding: 30px;
            margin: 20px 0;
        }

        .rest-screen h3 {
            color: #00ffff;
            margin-bottom: 15px;
            text-align: center;
        }

        .perspective-indicator {
            background: rgba(252, 211, 77, 0.2);
            border: 2px solid #fcd34d;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #fcd34d;
            font-weight: bold;
        }

        .warning-box {
            background: rgba(255, 0, 0, 0.2);
            border: 3px solid #ff0000;
            padding: 20px;
            margin: 20px 0;
            animation: glow 2s ease-in-out infinite;
        }

        .warning-box h3 {
            color: #ff0000;
            margin-bottom: 10px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(0, 20, 0, 0.95);
            border: 4px solid #00ff00;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #ff0000;
            font-size: 2em;
            cursor: pointer;
        }

        .glossary-entry {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 255, 0, 0.05);
            border-left: 4px solid #00ff00;
        }

        .glossary-term {
            color: #fcd34d;
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .glossary-pronunciation {
            color: #ff00ff;
            font-style: italic;
            margin-bottom: 5px;
        }

        .glossary-definition {
            color: #00ff00;
            line-height: 1.6;
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #001100;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff00;
            border: 2px solid #001100;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainMenu" class="pixel-border">
            <div class="main-menu">
                <h1 class="title">॥ श्री रामायणम् ॥</h1>
                <p class="subtitle">The Ramayana: Path of Dharma</p>
                <p style="color: #00ff00; margin-bottom: 40px;">
                    ⚡ AN INTERACTIVE JOURNEY ⚡<br>~ 80s RETRO EDITION ~<br>
                    <small style="color: #fcd34d;">AUTHENTIC VALMIKI RAMAYANA</small><br>
                    <small style="color: #00ffff;">v4.0 - Complete & Final</small>
                </p>
                <div class="menu-buttons">
                    <button class="btn" onclick="showCharacterSelect()">▶ NEW GAME</button>
                    <button class="btn" onclick="continueGame()" id="continueBtn" style="display: none;">⏩ CONTINUE</button>
                    <button class="btn btn-secondary" onclick="showHowToPlay()">📖 HOW TO PLAY</button>
                    <button class="btn btn-secondary" onclick="showGlossary()">📚 GLOSSARY</button>
                </div>
            </div>
        </div>

        <div id="characterSelect" class="hidden pixel-border">
            <div class="character-selection">
                <h2 class="title">SELECT YOUR PATH</h2>
                <p class="subtitle">Each character experiences the divine story differently</p>
                <div class="character-grid">
                    <div class="character-card" onclick="selectCharacter('rama')">
                        <div class="character-name">श्री राम</div>
                        <div class="character-desc">The ideal king, perfect son, embodiment of dharma.</div>
                        <div class="character-stats">
                            <div class="stat-line">⚔️ Dharma: ★★★★★</div>
                            <div class="stat-line">👑 Leadership: ★★★★★</div>
                            <div class="stat-line">📿 Path: RAJDHARMA</div>
                        </div>
                    </div>
                    <div class="character-card" onclick="selectCharacter('sita')">
                        <div class="character-name">माता सीता</div>
                        <div class="character-desc">Divine mother, strength through devotion.</div>
                        <div class="character-stats">
                            <div class="stat-line">🙏 Devotion: ★★★★★</div>
                            <div class="stat-line">✨ Purity: ★★★★★</div>
                            <div class="stat-line">📿 Path: PATIVRATA DHARMA</div>
                        </div>
                    </div>
                    <div class="character-card" onclick="selectCharacter('lakshmana')">
                        <div class="character-name">लक्ष्मण</div>
                        <div class="character-desc">Devoted brother, protector, selfless servant.</div>
                        <div class="character-stats">
                            <div class="stat-line">🛡️ Loyalty: ★★★★★</div>
                            <div class="stat-line">⚔️ Protection: ★★★★★</div>
                            <div class="stat-line">📿 Path: SEVA DHARMA</div>
                        </div>
                    </div>
                    <div class="character-card" onclick="selectCharacter('hanuman')">
                        <div class="character-name">हनुमान जी</div>
                        <div class="character-desc">Mighty devotee, unlimited devotional power.</div>
                        <div class="character-stats">
                            <div class="stat-line">💖 Bhakti: ★★★★★</div>
                            <div class="stat-line">💪 Strength: ★★★★★</div>
                            <div class="stat-line">📿 Path: BHAKTI DHARMA</div>
                        </div>
                    </div>
                </div>
                <button class="btn mt-20" onclick="showMainMenu()">← BACK</button>
            </div>
        </div>

        <div id="gameScreen" class="hidden">
            <div class="game-header pixel-border">
                <h1 class="game-title">॥ श्री रामायणम् ॥</h1>
                <div class="location-display" id="locationDisplay">AYODHYA PALACE</div>
                <div style="color: #00ff00; margin-top: 10px;">
                    PLAYING AS: <span id="currentCharacter" style="color: #fcd34d;"></span>
                </div>
            </div>
            <div class="game-screen">
                <div class="panel">
                    <div class="panel-title">⚡ RESOURCES ⚡</div>
                    <div class="resource">
                        <div class="resource-label">
                            <span id="energyLabel">ENERGY</span>
                            <span id="energyValue">100</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-fill energy-fill" id="energyBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="resource">
                        <div class="resource-label">
                            <span>DIVINE FAVOR</span>
                            <span id="favorValue">50</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-fill favor-fill" id="favorBar" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="resource">
                        <div class="resource-label">
                            <span>TAPAS</span>
                            <span id="tapasValue">0</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-fill tapas-fill" id="tapasBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #00ff00;">
                        <div class="panel-title" style="font-size: 1.1em;">GUNAS</div>
                        <div class="stat-line">SATTVA: <span id="sattvaValue">5</span></div>
                        <div class="stat-line">RAJAS: <span id="rajasValue">5</span></div>
                        <div class="stat-line">TAMAS: <span id="tamasValue">0</span></div>
                    </div>
                    <button class="btn mt-20" style="width: 100%; font-size: 0.9em;" onclick="showGlossary()">📚 GLOSSARY</button>
                </div>
                <div class="story-panel">
                    <div class="chapter-title" id="chapterTitle">CHAPTER 1</div>
                    <div id="storyContent"></div>
                </div>
                <div class="panel">
                    <div class="panel-title">⭐ CHARACTER ⭐</div>
                    <div id="characterInfo"></div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #00ff00;">
                        <div class="panel-title" style="font-size: 1.1em;">KARMA</div>
                        <div id="karmaDisplay"></div>
                    </div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #00ff00;">
                        <div class="panel-title" style="font-size: 1.1em;">WEAPONS</div>
                        <div id="weaponsDisplay">
                            <p style="color: #ff00ff; font-style: italic;">NONE YET</p>
                        </div>
                    </div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #00ff00;">
                        <div class="panel-title" style="font-size: 1.1em;">SAGE LESSONS</div>
                        <div id="lessonsDisplay">
                            <p style="color: #00ffff; font-style: italic;">NONE YET</p>
                        </div>
                    </div>
                    <button class="btn mt-20" style="width: 100%; font-size: 0.9em;" onclick="saveGame()">💾 SAVE</button>
                    <button class="btn btn-secondary mt-20" style="width: 100%; font-size: 0.9em;" onclick="showMainMenu()">← MENU</button>
                </div>
            </div>
        </div>
    </div>

    <div id="glossaryModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('glossaryModal')">✕</button>
            <h2 class="title" style="font-size: 2em;">📚 GLOSSARY</h2>
            <div id="glossaryContent"></div>
        </div>
    </div>

    <div id="howToPlayModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('howToPlayModal')">✕</button>
            <h2 class="title" style="font-size: 2em;">📖 HOW TO PLAY</h2>
            <div id="howToPlayContent"></div>
        </div>
    </div>

    <script>
        // GLOBAL GAME STATE
        let gameState = {
            character: null,
            currentChapter: 0,
            location: 'Ayodhya Palace',
            resources: { energy: 100, favor: 50, tapas: 0 },
            gunas: { sattva: 5, rajas: 5, tamas: 0 },
            karma: { truth: 5, duty: 5, compassion: 5, wisdom: 5, courage: 5, selfControl: 5 },
            weapons: [],
            sageLesson: [],
            choices: [],
            unlockedPaths: [],
            battleStats: { wins: 0, losses: 0 }
        };

        // BATTLE STATE
        let battleState = {
            active: false,
            canvas: null,
            ctx: null,
            playerWeapon: null,
            enemyWeapon: null,
            animationFrame: null,
            currentChapter: 0,
            round: 1,
            playerHealth: 100,
            enemyHealth: 100,
            playerDefending: false,
            enemyDefending: false,
            perspective: 'first',
            battleLog: []
        };

        // WEAPON DEFINITIONS
        const astras = {
            'Brahmastra': {
                name: 'ब्रह्मास्त्र (Brahmastra)',
                power: 100,
                color: '#ffffff',
                description: 'The ultimate divine weapon',
                animation: 'divine_light',
                nature: 'divine',
                effectiveAgainst: ['demonic', 'illusion', 'dark']
            },
            'Narayana Astra': {
                name: 'नारायणास्त्र (Narayana Astra)',
                power: 95,
                color: '#0088ff',
                description: "Vishnu's personal weapon",
                animation: 'spinning_chakra',
                nature: 'divine',
                effectiveAgainst: ['demonic', 'dark']
            },
            'Agneya': {
                name: 'आग्नेयास्त्र (Agneya)',
                power: 70,
                color: '#ff4400',
                description: 'Fire weapon of Agni',
                animation: 'fire_blast',
                nature: 'elemental',
                effectiveAgainst: ['demonic', 'illusion']
            },
            'Varunastra': {
                name: 'वरुणास्त्र (Varunastra)',
                power: 65,
                color: '#00aaff',
                description: 'Water weapon of Varuna',
                animation: 'water_wave',
                nature: 'elemental',
                effectiveAgainst: ['demonic', 'physical']
            },
            'Sanjeevani': {
                name: 'संजीवनी (Sanjeevani)',
                power: 50,
                color: '#00ff00',
                description: 'Healing weapon',
                animation: 'healing_light',
                nature: 'healing',
                effectiveAgainst: ['demonic', 'dark']
            },
            'Twashtar': {
                name: 'त्वष्टार् (Twashtar)',
                power: 60,
                color: '#ffaa00',
                description: 'Defensive weapon',
                animation: 'golden_shield',
                nature: 'defensive',
                effectiveAgainst: []
            },
            'Bow and Arrow': {
                name: 'धनुष बाण (Regular Bow)',
                power: 40,
                color: '#8B4513',
                description: 'Trusty bow with dharmic arrows',
                animation: 'arrow_flight',
                nature: 'physical',
                effectiveAgainst: []
            }
        };

        const demonWeapons = {
            'Maya Illusion': {
                name: 'माया (Maya Illusion)',
                power: 60,
                color: '#ff00ff',
                nature: 'illusion',
                effectiveAgainst: ['physical']
            },
            'Demon Claw': {
                name: 'राक्षस नख (Demon Claw)',
                power: 50,
                color: '#ff0000',
                nature: 'physical',
                effectiveAgainst: []
            },
            'Dark Magic': {
                name: 'तामसिक माया (Dark Magic)',
                power: 75,
                color: '#800080',
                nature: 'dark',
                effectiveAgainst: ['physical', 'elemental']
            },
            'Demon Army': {
                name: 'राक्षस सेना (Demon Horde)',
                power: 85,
                color: '#cc0000',
                nature: 'demonic',
                effectiveAgainst: ['physical']
            }
        };

        // GLOSSARY DATA
        const glossary = {
            dharma: {
                term: "Dharma (धर्म)",
                pronunciation: "DHAR-muh",
                definition: "Righteousness, duty, cosmic law. The fundamental principle of righteous living that sustains the universe."
            },
            tapas: {
                term: "Tapas (तपस्)",
                pronunciation: "TAH-puhs",
                definition: "Spiritual austerity, disciplined practice, inner heat of dedication. Through tapas, sages gain supernatural powers."
            },
            sattva: {
                term: "Sattva (सत्त्व)",
                pronunciation: "SUHT-vuh",
                definition: "Purity, clarity, harmony. One of the three gunas. Represents divine qualities like wisdom, peace, and truth."
            },
            rajas: {
                term: "Rajas (रजस्)",
                pronunciation: "RAH-juhs",
                definition: "Passion, activity, desire. The quality of movement and ambition. Necessary for action but can lead to attachment."
            },
            tamas: {
                term: "Tamas (तमस्)",
                pronunciation: "TAH-muhs",
                definition: "Darkness, inertia, ignorance. The quality of heaviness and delusion."
            },
            astra: {
                term: "Astra (अस्त्र)",
                pronunciation: "UHS-truh",
                definition: "Divine weapon invoked through mantras. Astras are supernatural forces controlled by consciousness."
            },
            karma: {
                term: "Karma (कर्म)",
                pronunciation: "KUR-muh",
                definition: "Action and its consequences. Every choice creates ripples through time."
            },
            bhakti: {
                term: "Bhakti (भक्ति)",
                pronunciation: "BHUHK-tee",
                definition: "Pure devotion, loving surrender to the divine."
            },
            rajdharma: {
                term: "Rajdharma (राजधर्म)",
                pronunciation: "RAHJ-dhar-muh",
                definition: "The sacred duty of kings to protect subjects, uphold justice, and rule with wisdom."
            },
            pativrata: {
                term: "Pativrata (पतिव्रता)",
                pronunciation: "puh-tee-VRAH-tuh",
                definition: "A woman devoted to her husband. Represents spiritual partnership and inner strength."
            },
            maya: {
                term: "Maya (माया)",
                pronunciation: "MAH-yah",
                definition: "Illusion, the power to make the unreal appear real."
            },
            indrajit: {
                term: "Indrajit / Meghnad (इन्द्रजित् / मेघनाद)",
                pronunciation: "in-druh-JIT / MAY-guh-naad",
                definition: "Ravana's eldest son. Killed by LAKSHMANA in single combat as per Valmiki Ramayana."
            }
        };

        // ===== CORE FUNCTIONS =====

        function init() {
            const saved = localStorage.getItem('ramayanaGameSave');
            if (saved) {
                document.getElementById('continueBtn').style.display = 'block';
            }
            loadGlossary();
            loadHowToPlay();
        }

        function showMainMenu() {
            hideAll();
            document.getElementById('mainMenu').classList.remove('hidden');
        }

        function showCharacterSelect() {
            hideAll();
            document.getElementById('characterSelect').classList.remove('hidden');
        }

        function hideAll() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('characterSelect').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
        }

        function selectCharacter(character) {
            gameState.character = character;
            gameState.currentChapter = 0;
            gameState.location = 'Ayodhya Palace';
            gameState.resources = { energy: 100, favor: 50, tapas: 0 };
            gameState.gunas = { sattva: 5, rajas: 5, tamas: 0 };
            gameState.karma = { truth: 5, duty: 5, compassion: 5, wisdom: 5, courage: 5, selfControl: 5 };
            gameState.weapons = [];
            gameState.sageLesson = [];
            gameState.choices = [];
            gameState.unlockedPaths = [];
            gameState.battleStats = { wins: 0, losses: 0 };

            hideAll();
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('currentCharacter').textContent = getCharacterDisplayName(character);
            loadChapter(0);
            updateUI();
        }

        function getCharacterDisplayName(character) {
            const names = {
                rama: 'श्री राम (RAMA)',
                sita: 'माता सीता (SITA)',
                lakshmana: 'लक्ष्मण (LAKSHMANA)',
                hanuman: 'हनुमान जी (HANUMAN)'
            };
            return names[character] || character.toUpperCase();
        }

        // ===== RESOURCE MANAGEMENT =====

        function checkResourceDepletion() {
            if (gameState.resources.energy < 20) {
                showRestScreen();
                return true;
            }
            return false;
        }

        function showRestScreen() {
            let html = '<div class="warning-box">';
            html += '<h3>⚠️ EXHAUSTION ⚠️</h3>';
            html += '<p style="color: #00ff00; margin: 15px 0;">Your energy is critically low. You must rest before continuing.</p>';
            html += '</div>';
            
            html += '<div class="rest-screen">';
            html += '<h3>🧘 CHOOSE HOW TO RESTORE 🧘</h3>';
            html += '<div class="choices">';
            html += '<button class="choice-btn" onclick="restChoice(\'sleep\')">😴 SLEEP - Restore 40 Energy, 10 Favor</button>';
            html += '<button class="choice-btn" onclick="restChoice(\'meditate\')">🧘 MEDITATE - Restore 30 Energy, 20 Tapas, 5 Sattva</button>';
            html += '<button class="choice-btn" onclick="restChoice(\'yajna\')">🔥 YAJNA - Restore 20 Energy, 30 Favor, 10 Tapas</button>';
            html += '</div></div>';
            
            document.getElementById('storyContent').innerHTML = html;
        }

        function restChoice(type) {
            let effects = {};
            let message = '';
            
            switch(type) {
                case 'sleep':
                    effects = { energy: 40, favor: 10 };
                    message = "You rest deeply. Your body recovers.";
                    break;
                case 'meditate':
                    effects = { energy: 30, tapas: 20, sattva: 5 };
                    message = "In deep meditation, you connect with the divine.";
                    break;
                case 'yajna':
                    effects = { energy: 20, favor: 30, tapas: 10 };
                    message = "The sacred fire burns brightly.";
                    break;
            }
            
            applyEffects(effects);
            
            let html = '<div class="feedback"><h3>⚡ RESTORED ⚡</h3><p>' + message + '</p>';
            if (effects.energy) html += '<div class="stat-change stat-positive">⚡ ENERGY: +' + effects.energy + '</div>';
            if (effects.favor) html += '<div class="stat-change stat-positive">✨ FAVOR: +' + effects.favor + '</div>';
            if (effects.tapas) html += '<div class="stat-change stat-positive">🔥 TAPAS: +' + effects.tapas + '</div>';
            if (effects.sattva) html += '<div class="stat-change stat-positive">☀️ SATTVA: +' + effects.sattva + '</div>';
            html += '<button class="btn mt-20" onclick="loadChapter(' + gameState.currentChapter + ')">▶ CONTINUE</button></div>';
            
            document.getElementById('storyContent').innerHTML = html;
            saveGame();
        }

        // ===== DAMAGE CALCULATION =====

        function calculateDamage(attackerWeapon, defenderWeapon, attackerKarma, attackerResources, isDefending) {
            let basePower = attackerWeapon.power;
            
            const courageBonus = attackerKarma.courage * 2;
            const wisdomBonus = attackerKarma.wisdom * 1.5;
            const tapasBonus = attackerResources.tapas * 0.5;
            const tamasPenalty = gameState.gunas.tamas * 3;
            
            let energyMultiplier = 1.0;
            if (attackerResources.energy < 30) {
                energyMultiplier = 0.7;
                if (battleState.battleLog) {
                    battleState.battleLog.push("⚠️ Low energy weakens attacks!");
                }
            }
            
            basePower += courageBonus + wisdomBonus + tapasBonus - tamasPenalty;
            basePower *= energyMultiplier;
            
            let matchupMultiplier = 1.0;
            if (attackerWeapon.effectiveAgainst && defenderWeapon && 
                attackerWeapon.effectiveAgainst.includes(defenderWeapon.nature)) {
                matchupMultiplier = 1.5;
                if (battleState.battleLog) {
                    battleState.battleLog.push("⚡ EFFECTIVE! " + attackerWeapon.nature + " vs " + defenderWeapon.nature);
                }
            }
            
            const chanceFactor = 0.85 + Math.random() * 0.3;
            const defenseMultiplier = isDefending ? 0.5 : 1.0;
            
            let damage = basePower * matchupMultiplier * chanceFactor * defenseMultiplier;
            damage = Math.max(10, Math.min(50, Math.round(damage)));
            
            return damage;
        }

        // ===== CHAPTER LOADING =====

        function loadChapter(chapterIndex) {
            if (checkResourceDepletion()) return;
            
            const chapters = getAllChapters(gameState.character);
            const chapter = chapters[chapterIndex];
            
            if (!chapter) {
                showEnding();
                return;
            }

            gameState.currentChapter = chapterIndex;
            gameState.location = chapter.location;
            document.getElementById('locationDisplay').textContent = chapter.location;
            document.getElementById('chapterTitle').textContent = chapter.title;

            let html = '';
            
            if (chapter.verse) {
                html += '<div class="verse">';
                html += '<div class="verse-sanskrit">' + chapter.verse.sanskrit + '</div>';
                html += '<div class="verse-translation">' + chapter.verse.translation + '</div>';
                html += '</div>';
            }

            if (chapter.sageTeaching) {
                html += '<div class="sage-teaching">';
                html += '<h3>🧘 ' + chapter.sageTeaching.sage + '</h3>';
                html += '<p>' + chapter.sageTeaching.lesson + '</p>';
                html += '</div>';
            }

            html += '<div class="story-text">' + chapter.text + '</div>';

            if (chapter.battle) {
                html += '<div class="text-center mt-20">';
                html += '<button class="btn" onclick="startBattle(' + chapterIndex + ')">⚔️ ENTER BATTLE ⚔️</button>';
                html += '</div>';
            } else {
                html += '<div class="choices">';
                for (let i = 0; i < chapter.choices.length; i++) {
                    const choice = chapter.choices[i];
                    const isLocked = choice.requiresLesson && !gameState.sageLesson.includes(choice.requiresLesson);
                    const lockedText = isLocked ? ' [🔒 REQUIRES: ' + choice.requiresLesson + ']' : '';
                    
                    html += '<button class="choice-btn" ';
                    html += 'onclick="' + (isLocked ? 'showLockedMessage()' : 'makeChoice(' + chapterIndex + ',' + i + ')') + '" ';
                    html += (isLocked ? 'disabled' : '') + '>';
                    html += choice.text + lockedText + '</button>';
                }
                html += '</div>';
            }

            document.getElementById('storyContent').innerHTML = html;
            updateCharacterInfo();
        }

        // ===== CHOICE SYSTEM =====

        function makeChoice(chapterIndex, choiceIndex) {
            const chapters = getAllChapters(gameState.character);
            const chapter = chapters[chapterIndex];
            const choice = chapter.choices[choiceIndex];

            gameState.choices.push({chapter: chapterIndex, choice: choiceIndex, text: choice.text});

            if (choice.failure) {
                showFailure(choice.outcome, chapterIndex);
                return;
            }

            applyEffects(choice.effects);

            if (choice.weapons) {
                choice.weapons.forEach(function(weapon) {
                    if (!gameState.weapons.includes(weapon)) gameState.weapons.push(weapon);
                });
            }

            if (choice.sageLesson && !gameState.sageLesson.includes(choice.sageLesson)) {
                gameState.sageLesson.push(choice.sageLesson);
            }

            if (choice.unlockPath && !gameState.unlockedPaths.includes(choice.unlockPath)) {
                gameState.unlockedPaths.push(choice.unlockPath);
            }

            showOutcome(choice);
            saveGame();
        }

        function applyEffects(effects) {
            if (!effects) return;

            if (effects.energy) gameState.resources.energy = Math.max(0, Math.min(100, gameState.resources.energy + effects.energy));
            if (effects.favor) gameState.resources.favor = Math.max(0, Math.min(100, gameState.resources.favor + effects.favor));
            if (effects.tapas) gameState.resources.tapas = Math.max(0, Math.min(100, gameState.resources.tapas + effects.tapas));

            if (effects.sattva) gameState.gunas.sattva = Math.max(0, gameState.gunas.sattva + effects.sattva);
            if (effects.rajas) gameState.gunas.rajas = Math.max(0, gameState.gunas.rajas + effects.rajas);
            if (effects.tamas) gameState.gunas.tamas = Math.max(0, gameState.gunas.tamas + effects.tamas);

            const karmaKeys = ['truth', 'duty', 'compassion', 'wisdom', 'courage', 'selfControl'];
            for (let i = 0; i < karmaKeys.length; i++) {
                const key = karmaKeys[i];
                if (effects[key]) gameState.karma[key] = Math.max(0, gameState.karma[key] + effects[key]);
            }

            updateUI();
        }

        function showOutcome(choice) {
            let html = '<div class="feedback"><h3>⚡ OUTCOME ⚡</h3><p>' + choice.outcome + '</p><h4 style="color: #00ffff; margin: 15px 0;">EFFECTS:</h4>';

            const effects = choice.effects;
            if (effects) {
                if (effects.energy) html += '<div class="stat-change ' + (effects.energy > 0 ? 'stat-positive' : 'stat-negative') + '">⚡ ENERGY: ' + (effects.energy > 0 ? '+' : '') + effects.energy + '</div>';
                if (effects.favor) html += '<div class="stat-change ' + (effects.favor > 0 ? 'stat-positive' : 'stat-negative') + '">✨ FAVOR: ' + (effects.favor > 0 ? '+' : '') + effects.favor + '</div>';
                if (effects.tapas) html += '<div class="stat-change ' + (effects.tapas > 0 ? 'stat-positive' : 'stat-negative') + '">🔥 TAPAS: ' + (effects.tapas > 0 ? '+' : '') + effects.tapas + '</div>';
                
                if (effects.sattva) html += '<div class="stat-change stat-positive">☀️ SATTVA: +' + effects.sattva + '</div>';
                if (effects.rajas) html += '<div class="stat-change stat-positive">⚡ RAJAS: +' + effects.rajas + '</div>';
                if (effects.tamas) html += '<div class="stat-change stat-negative">🌑 TAMAS: +' + effects.tamas + '</div>';

                const virtueNames = {truth: 'TRUTH', duty: 'DUTY', compassion: 'COMPASSION', wisdom: 'WISDOM', courage: 'COURAGE', selfControl: 'SELF-CONTROL'};
                for (var key in virtueNames) {
                    if (effects[key]) html += '<div class="stat-change stat-positive">📿 ' + virtueNames[key] + ': +' + effects[key] + '</div>';
                }
            }

            if (choice.weapons) html += '<div class="stat-change stat-positive">⚔️ ACQUIRED: ' + choice.weapons.join(', ') + '</div>';
            if (choice.sageLesson) html += '<div class="stat-change stat-positive">📚 LEARNED: ' + choice.sageLesson + '</div>';

            html += '<button class="btn mt-20" onclick="advanceChapter()">▶ CONTINUE</button></div>';
            document.getElementById('storyContent').innerHTML = html;
        }

        function showFailure(outcome, chapterIndex) {
            let html = '<div class="death-screen"><h2>⚠️ PATH BLOCKED ⚠️</h2><div class="lesson">';
            html += '<p>' + outcome + '</p><p>Reflect and try again.</p></div>';
            html += '<button class="btn mt-20" onclick="retryChapter(' + chapterIndex + ')">🔄 TRY AGAIN</button>';
            html += '<button class="btn btn-secondary mt-20" onclick="showMainMenu()">← MENU</button></div>';
            document.getElementById('storyContent').innerHTML = html;
        }

        function retryChapter(chapterIndex) {
            gameState.resources.energy = Math.min(100, gameState.resources.energy + 10);
            gameState.resources.favor = Math.min(100, gameState.resources.favor + 5);
            updateUI();
            loadChapter(chapterIndex);
        }

        function advanceChapter() {
            gameState.currentChapter++;
            loadChapter(gameState.currentChapter);
            saveGame();
        }

        function showLockedMessage() {
            alert('This choice requires a sage lesson you haven\'t learned yet!');
        }

        // ===== BATTLE SYSTEM =====

        function startBattle(chapterIndex) {
            const chapters = getAllChapters(gameState.character);
            const chapter = chapters[chapterIndex];
            const battle = chapter.battle;
            
            if (battle.characterRestriction && !battle.characterRestriction.includes(gameState.character)) {
                alert("This battle is not yours! Play as " + battle.characterRestriction.join(" or ") + ".");
                return;
            }

            battleState.currentChapter = chapterIndex;
            battleState.active = true;
            battleState.playerHealth = 100;
            battleState.enemyHealth = battle.enemyHealth || 100;
            battleState.round = 1;
            battleState.playerDefending = false;
            battleState.enemyDefending = false;
            battleState.perspective = 'first';
            battleState.battleLog = [];

            showBattleScreen(battle);
        }

        function showBattleScreen(battle) {
            if (battleState.round % 2 === 0) {
                battleState.perspective = 'third';
            } else {
                battleState.perspective = 'first';
            }

            let html = '<div class="battle-screen">';
            html += '<div class="battle-title">⛔ BATTLE: ' + battle.enemy.toUpperCase() + ' ⛔</div>';
            
            const perspectiveText = battleState.perspective === 'first' ? 
                '👁️ FIRST PERSON VIEW' : '🎬 THIRD PERSON VIEW';
            html += '<div class="perspective-indicator">' + perspectiveText + '</div>';
            html += '<div style="text-align: center; color: #fcd34d; margin: 10px 0;">ROUND ' + battleState.round + '</div>';
            html += '<canvas id="battleCanvas" class="battle-canvas" width="800" height="400"></canvas>';
            
            if (battleState.battleLog.length > 0) {
                html += '<div class="battle-log">';
                for (let i = Math.max(0, battleState.battleLog.length - 10); i < battleState.battleLog.length; i++) {
                    html += '<div class="log-entry">' + battleState.battleLog[i] + '</div>';
                }
                html += '</div>';
            }
            
            html += '<div class="weapon-selection"><h3>⚔️ SELECT ACTION ⚔️</h3><div class="weapon-grid">';
            html += '<button class="defend-btn" onclick="selectDefend()">🛡️ DEFEND<br><small>-50% damage</small></button>';
            
            const availableAstras = ['Bow and Arrow'];
            gameState.weapons.forEach(function(weapon) {
                if (astras[weapon]) availableAstras.push(weapon);
            });
            
            availableAstras.forEach(function(weapon) {
                const astra = astras[weapon];
                if (astra) {
                    let effectiveText = '';
                    if (astra.effectiveAgainst && astra.effectiveAgainst.length > 0) {
                        effectiveText = '<br><small style="color: #00ff00;">✓ vs: ' + astra.effectiveAgainst.join(', ') + '</small>';
                    }
                    html += '<button class="astra-btn" onclick="selectWeapon(\'' + weapon + '\')">';
                    html += astra.name + '<br><small>' + astra.description + '</small>' + effectiveText + '</button>';
                }
            });
            
            html += '</div>';
            
            if (gameState.resources.energy < 30) {
                html += '<p style="color: #ff0000; margin-top: 15px;">⚠️ LOW ENERGY! Attacks 30% weaker!</p>';
            }
            
            html += '</div><div class="text-center mt-20">';
            html += '<button class="btn btn-secondary" onclick="retreatFromBattle()">🏃 RETREAT</button>';
            html += '</div></div>';
            
            document.getElementById('storyContent').innerHTML = html;
            
            setTimeout(function() {
                battleState.canvas = document.getElementById('battleCanvas');
                if (battleState.canvas) {
                    battleState.ctx = battleState.canvas.getContext('2d');
                    drawBattleField();
                }
            }, 100);
        }

        function selectDefend() {
            battleState.playerDefending = true;
            battleState.playerWeapon = null;
            battleState.battleLog.push("🛡️ You defend!");
            selectEnemyAction();
            setTimeout(function() { resolveBattleRound(); }, 1000);
        }

        function selectWeapon(weaponName) {
            battleState.playerWeapon = weaponName;
            battleState.playerDefending = false;
            selectEnemyAction();
            startBattleAnimation();
        }

        function selectEnemyAction() {
            const chapters = getAllChapters(gameState.character);
            const battle = chapters[battleState.currentChapter].battle;
            
            if (Math.random() < 0.3) {
                battleState.enemyDefending = true;
                battleState.enemyWeapon = null;
                battleState.battleLog.push("🛡️ Enemy defends!");
            } else {
                battleState.enemyDefending = false;
                
                if (battle.enemy.includes('Illusion') || battle.enemy.includes('Khar')) {
                    battleState.enemyWeapon = 'Maya Illusion';
                } else if (battle.enemy.includes('14,000') || battle.enemy.includes('Army')) {
                    battleState.enemyWeapon = 'Demon Army';
                } else if (battle.enemy.includes('Ravana') || battle.enemy.includes('Indrajit')) {
                    battleState.enemyWeapon = 'Dark Magic';
                } else {
                    battleState.enemyWeapon = 'Demon Claw';
                }
            }
        }

        function startBattleAnimation() {
            if (!battleState.ctx || !battleState.canvas) {
                resolveBattleRound();
                return;
            }
            
            const playerAstra = astras[battleState.playerWeapon];
            const enemyWeapon = demonWeapons[battleState.enemyWeapon];
            
            if (playerAstra) battleState.battleLog.push("⚔️ You: " + playerAstra.name);
            if (enemyWeapon) battleState.battleLog.push("⚔️ Enemy: " + enemyWeapon.name);
            
            animateWeaponClash();
        }

        function animateWeaponClash() {
            if (!battleState.playerWeapon && !battleState.enemyWeapon) {
                resolveBattleRound();
                return;
            }
            
            let animationStep = 0;
            const maxSteps = 60;
            
            function animate() {
                drawBattleField();
                
                const progress = animationStep / maxSteps;
                
                if (battleState.playerWeapon) drawWeaponAnimation(battleState.playerWeapon, progress, 'player');
                if (battleState.enemyWeapon) drawWeaponAnimation(battleState.enemyWeapon, progress, 'enemy');
                
                animationStep++;
                
                if (animationStep < maxSteps) {
                    battleState.animationFrame = requestAnimationFrame(animate);
                } else {
                    resolveBattleRound();
                }
            }
            
            animate();
        }

        function drawBattleField() {
            const ctx = battleState.ctx;
            const canvas = battleState.canvas;
            
            if (!ctx || !canvas) return;
            
            ctx.fillStyle = '#001100';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#2d4a2d';
            ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
            
            if (battleState.perspective === 'first') {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(canvas.width / 2 - 30, canvas.height - 100, 60, 80);
                ctx.fillStyle = '#fcd34d';
                ctx.fillRect(canvas.width / 2 - 5, canvas.height - 120, 10, 100);
                
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(canvas.width - 160, canvas.height - 150, 60, 100);
                ctx.fillStyle = '#800000';
                ctx.fillRect(canvas.width - 150, canvas.height - 160, 40, 20);
            } else {
                ctx.fillStyle = '#fcd34d';
                ctx.fillRect(100, canvas.height - 150, 60, 100);
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(110, canvas.height - 160, 40, 20);
                
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(canvas.width - 160, canvas.height - 150, 60, 100);
                ctx.fillStyle = '#800000';
                ctx.fillRect(canvas.width - 150, canvas.height - 160, 40, 20);
            }
            
            drawHealthBars();
        }

        function drawHealthBars() {
            const ctx = battleState.ctx;
            const canvas = battleState.canvas;
            
            if (!ctx || !canvas) return;
            
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(50, 30, 200, 20);
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(50, 30, (battleState.playerHealth / 100) * 200, 20);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px Courier';
            ctx.fillText('PLAYER: ' + Math.round(battleState.playerHealth) + '%', 50, 25);
            
            const maxEnemyHealth = getAllChapters(gameState.character)[battleState.currentChapter].battle.enemyHealth || 100;
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(canvas.width - 250, 30, 200, 20);
            ctx.fillStyle = '#ff4444';
            ctx.fillRect(canvas.width - 250, 30, (battleState.enemyHealth / maxEnemyHealth) * 200, 20);
            
            ctx.fillStyle = '#ffffff';
            ctx.fillText('ENEMY: ' + Math.round(battleState.enemyHealth) + '%', canvas.width - 250, 25);
        }

        function drawWeaponAnimation(weaponName, progress, side) {
            const ctx = battleState.ctx;
            const canvas = battleState.canvas;
            const weapon = side === 'player' ? astras[weaponName] : demonWeapons[weaponName];
            
            if (!weapon || !ctx) return;
            
            let startX, endX, y;
            
            if (battleState.perspective === 'first' && side === 'player') {
                startX = canvas.width / 2;
                endX = canvas.width - 130;
                y = canvas.height - 60;
            } else if (side === 'player') {
                startX = 130;
                endX = canvas.width - 200;
                y = canvas.height - 100;
            } else {
                startX = canvas.width - 130;
                endX = 200;
                y = canvas.height - 100;
            }
            
            const currentX = startX + (endX - startX) * progress;
            
            ctx.fillStyle = weapon.color;
            ctx.globalAlpha = 0.8;
            
            switch(weapon.animation || 'default') {
                case 'divine_light':
                    const radius = 20 + progress * 50;
                    ctx.beginPath();
                    ctx.arc(currentX, y, radius, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'fire_blast':
                    for (let i = 0; i < 5; i++) {
                        ctx.fillStyle = i % 2 ? '#ff4400' : '#ffaa00';
                        ctx.fillRect(currentX - 10 + i * 5, y - 10 + i * 3, 20, 20);
                    }
                    break;
                case 'arrow_flight':
                    ctx.fillRect(currentX - 15, y - 2, 30, 4);
                    ctx.fillRect(currentX + 10, y - 5, 10, 10);
                    break;
                default:
                    ctx.fillRect(currentX - 10, y - 5, 20, 10);
            }
            
            ctx.globalAlpha = 1.0;
        }

        function resolveBattleRound() {
            let playerDamage = 0;
            let enemyDamage = 0;
            
            if (battleState.playerWeapon && !battleState.enemyDefending) {
                const playerAstra = astras[battleState.playerWeapon];
                const enemyWeapon = demonWeapons[battleState.enemyWeapon];
                playerDamage = calculateDamage(playerAstra, enemyWeapon, gameState.karma, gameState.resources, false);
                battleState.enemyHealth -= playerDamage;
                battleState.battleLog.push("💥 You deal " + playerDamage + " damage!");
            } else if (battleState.playerWeapon && battleState.enemyDefending) {
                const playerAstra = astras[battleState.playerWeapon];
                playerDamage = calculateDamage(playerAstra, null, gameState.karma, gameState.resources, true);
                battleState.enemyHealth -= playerDamage;
                battleState.battleLog.push("🛡️ Enemy defends! You deal " + playerDamage + "!");
            }
            
            if (battleState.enemyWeapon && !battleState.playerDefending) {
                const enemyWeapon = demonWeapons[battleState.enemyWeapon];
                const chapters = getAllChapters(gameState.character);
                const battle = chapters[battleState.currentChapter].battle;
                enemyWeapon.power = battle.enemyPower || 30;
                const playerAstra = astras[battleState.playerWeapon];
                enemyDamage = calculateDamage(enemyWeapon, playerAstra, {courage: 3, wisdom: 2}, {energy: 100, tapas: 0}, false);
                battleState.playerHealth -= enemyDamage;
                battleState.battleLog.push("💢 Enemy deals " + enemyDamage + "!");
            } else if (battleState.enemyWeapon && battleState.playerDefending) {
                const enemyWeapon = demonWeapons[battleState.enemyWeapon];
                const chapters = getAllChapters(gameState.character);
                const battle = chapters[battleState.currentChapter].battle;
                enemyWeapon.power = battle.enemyPower || 30;
                enemyDamage = calculateDamage(enemyWeapon, null, {courage: 3, wisdom: 2}, {energy: 100, tapas: 0}, true);
                battleState.playerHealth -= enemyDamage;
                battleState.battleLog.push("🛡️ You defend! Enemy deals " + enemyDamage + "!");
            }
            
            if (battleState.enemyHealth <= 0) {
                battleVictory();
                return;
            }
            
            if (battleState.playerHealth <= 0) {
                battleDefeat();
                return;
            }
            
            battleState.round++;
            gameState.resources.energy = Math.max(0, gameState.resources.energy - 3);
            updateUI();
            
            setTimeout(function() {
                const chapters = getAllChapters(gameState.character);
                const battle = chapters[battleState.currentChapter].battle;
                showBattleScreen(battle);
            }, 500);
        }

        function battleVictory() {
            gameState.battleStats.wins++;
            gameState.resources.energy = Math.max(0, gameState.resources.energy - 15);
            
            let html = '<div class="battle-result"><h2 style="color: #00ff00;">⚔️ VICTORY! ⚔️</h2>';
            html += '<p>Dharma triumphs!</p>';
            html += '<div class="stat-change stat-negative">⚡ EXHAUSTION: -15 Energy</div>';
            html += '<div class="stat-change stat-positive">🏆 WINS: ' + gameState.battleStats.wins + '</div>';
            html += '<button class="btn mt-20" onclick="advanceChapter()">▶ CONTINUE</button></div>';
            
            document.getElementById('storyContent').innerHTML = html;
            saveGame();
        }

        function battleDefeat() {
            gameState.battleStats.losses++;
            
            let html = '<div class="death-screen"><h2>💀 DEFEAT 💀</h2><div class="lesson">';
            html += '<p>You have fallen. Reflect on your choices.</p></div>';
            html += '<button class="btn mt-20" onclick="retryChapter(' + battleState.currentChapter + ')">🔄 TRY AGAIN</button>';
            html += '<button class="btn btn-secondary mt-20" onclick="showMainMenu()">← MENU</button></div>';
            
            document.getElementById('storyContent').innerHTML = html;
        }

        function retreatFromBattle() {
            if (confirm("Retreat? This costs 25 energy.")) {
                gameState.resources.energy = Math.max(0, gameState.resources.energy - 25);
                updateUI();
                
                let html = '<div class="feedback"><h3>🏃 RETREAT 🏃</h3>';
                html += '<p>Sometimes wisdom means withdrawing.</p>';
                html += '<div class="stat-change stat-negative">⚡ ENERGY: -25</div>';
                html += '<button class="btn mt-20" onclick="loadChapter(' + gameState.currentChapter + ')">▶ REGROUP</button></div>';
                
                document.getElementById('storyContent').innerHTML = html;
            }
        }

        // ===== UI =====

        function updateUI() {
            document.getElementById('energyValue').textContent = Math.round(gameState.resources.energy);
            document.getElementById('favorValue').textContent = Math.round(gameState.resources.favor);
            document.getElementById('tapasValue').textContent = Math.round(gameState.resources.tapas);
            
            document.getElementById('energyBar').style.width = gameState.resources.energy + '%';
            document.getElementById('favorBar').style.width = gameState.resources.favor + '%';
            document.getElementById('tapasBar').style.width = gameState.resources.tapas + '%';
            
            const energyLabel = document.getElementById('energyLabel');
            if (gameState.resources.energy < 30) {
                energyLabel.classList.add('low-resource');
            } else {
                energyLabel.classList.remove('low-resource');
            }
            
            document.getElementById('sattvaValue').textContent = gameState.gunas.sattva;
            document.getElementById('rajasValue').textContent = gameState.gunas.rajas;
            document.getElementById('tamasValue').textContent = gameState.gunas.tamas;
            
            updateCharacterInfo();
        }

        function updateCharacterInfo() {
            let karmaHtml = '';
            const karmaKeys = ['truth', 'duty', 'compassion', 'wisdom', 'courage', 'selfControl'];
            const karmaNames = {truth: 'Truth', duty: 'Duty', compassion: 'Compassion', wisdom: 'Wisdom', courage: 'Courage', selfControl: 'Self-Control'};
            
            karmaKeys.forEach(function(key) {
                karmaHtml += '<div class="stat-line">' + karmaNames[key] + ': ' + gameState.karma[key] + '</div>';
            });
            document.getElementById('karmaDisplay').innerHTML = karmaHtml;
            
            let weaponsHtml = '';
            if (gameState.weapons.length === 0) {
                weaponsHtml = '<p style="color: #ff00ff; font-style: italic;">NONE YET</p>';
            } else {
                gameState.weapons.forEach(function(weapon) {
                    weaponsHtml += '<div class="stat-line" style="color: #ff00ff;">⚔️ ' + weapon + '</div>';
                });
            }
            document.getElementById('weaponsDisplay').innerHTML = weaponsHtml;
            
            let lessonsHtml = '';
            if (gameState.sageLesson.length === 0) {
                lessonsHtml = '<p style="color: #00ffff; font-style: italic;">NONE YET</p>';
            } else {
                gameState.sageLesson.forEach(function(lesson) {
                    lessonsHtml += '<div class="stat-line" style="color: #00ffff;">📚 ' + lesson + '</div>';
                });
            }
            document.getElementById('lessonsDisplay').innerHTML = lessonsHtml;
        }

        // ===== SAVE/LOAD =====

        function saveGame() {
            localStorage.setItem('ramayanaGameSave', JSON.stringify(gameState));
        }

        function continueGame() {
            const saved = localStorage.getItem('ramayanaGameSave');
            if (saved) {
                gameState = JSON.parse(saved);
                hideAll();
                document.getElementById('gameScreen').classList.remove('hidden');
                document.getElementById('currentCharacter').textContent = getCharacterDisplayName(gameState.character);
                loadChapter(gameState.currentChapter);
                updateUI();
            }
        }

        // ===== ENDING =====

        function showEnding() {
            let html = '<div style="text-align: center; padding: 40px;">';
            html += '<h1 style="color: #fcd34d; font-size: 3em; animation: glow 2s ease-in-out infinite;">🙏 JAI SHRI RAM 🙏</h1>';
            html += '<div style="color: #00ff00; font-size: 1.3em; line-height: 2; margin: 30px 0;">';
            html += '<p>You have completed the Ramayana!</p>';
            html += '<p style="margin-top: 20px; color: #fcd34d;">May you carry these lessons into your life.</p></div>';
            
            html += '<div style="margin: 40px 0; padding: 30px; background: rgba(0, 255, 255, 0.1); border: 3px solid #00ffff;">';
            html += '<h3 style="color: #00ffff;">YOUR JOURNEY</h3>';
            html += '<div style="color: #00ff00; line-height: 2;">';
            html += '<p>Character: ' + getCharacterDisplayName(gameState.character) + '</p>';
            html += '<p>Battles Won: ' + gameState.battleStats.wins + '</p>';
            html += '<p>Sage Lessons: ' + gameState.sageLesson.length + '</p>';
            html += '<p>Weapons: ' + gameState.weapons.length + '</p>';
            html += '<p>Final Sattva: ' + gameState.gunas.sattva + '</p></div></div>';
            
            html += '<button class="btn mt-20" onclick="showCharacterSelect()">▶ PLAY AGAIN</button>';
            html += '<button class="btn btn-secondary mt-20" onclick="showMainMenu()">← MENU</button></div>';
            
            document.getElementById('storyContent').innerHTML = html;
        }

        // ===== GLOSSARY & HOW TO PLAY =====

        function loadGlossary() {
            let html = '';
            for (const key in glossary) {
                const entry = glossary[key];
                html += '<div class="glossary-entry">';
                html += '<div class="glossary-term">' + entry.term + '</div>';
                html += '<div class="glossary-pronunciation">' + entry.pronunciation + '</div>';
                html += '<div class="glossary-definition">' + entry.definition + '</div></div>';
            }
            document.getElementById('glossaryContent').innerHTML = html;
        }

        function loadHowToPlay() {
            let html = '<div style="color: #00ff00; line-height: 1.8;">';
            
            html += '<h3 style="color: #fcd34d; margin: 20px 0;">🎮 GAMEPLAY</h3>';
            html += '<p>Play through 21 chapters as Rama, Sita, Lakshmana, or Hanuman. Each has unique battles.</p>';
            
            html += '<h3 style="color: #fcd34d; margin: 20px 0;">⚔️ COMBAT</h3>';
            html += '<ul style="margin-left: 20px;">';
            html += '<li>🎲 Dynamic damage: karma + weapons + matchups + variance</li>';
            html += '<li>⚖️ Divine weapons deal 50% more to demons!</li>';
            html += '<li>🛡️ Defend to reduce damage 50%</li>';
            html += '<li>⚡ Low energy (<30) weakens attacks 30%</li>';
            html += '<li>📉 High tamas weakens you</li>';
            html += '<li>👁️ Perspectives alternate</li></ul>';
            
            html += '<h3 style="color: #fcd34d; margin: 20px 0;">⚡ RESOURCES</h3>';
            html += '<ul style="margin-left: 20px;">';
            html += '<li>Energy <20: forced rest</li>';
            html += '<li>-15 energy per victory</li>';
            html += '<li>-3 energy per round</li></ul>';
            
            html += '<h3 style="color: #fcd34d; margin: 20px 0;">🌟 KARMA</h3>';
            html += '<p>Six virtues: Truth, Duty, Compassion, Wisdom, Courage, Self-Control.</p>';
            
            html += '<h3 style="color: #fcd34d; margin: 20px 0;">🧘 GUNAS</h3>';
            html += '<ul style="margin-left: 20px;">';
            html += '<li>Sattva: purity/wisdom</li>';
            html += '<li>Rajas: passion/action</li>';
            html += '<li>Tamas: ignorance (WEAKENS!)</li></ul>';
            
            html += '<h3 style="color: #fcd34d; margin: 20px 0;">💡 TIPS</h3>';
            html += '<ul style="margin-left: 20px;">';
            html += '<li>✨ Divine weapons vs demons!</li>';
            html += '<li>⚡ Keep energy high</li>';
            html += '<li>🛡️ Defend when low</li>';
            html += '<li>📿 Avoid tamas</li>';
            html += '<li>⚔️ Play Lakshmana for Indrajit!</li></ul>';
            
            html += '<p style="margin-top: 30px; color: #fcd34d;">॥ Authentic Valmiki Ramayana! ॐ ॥</p></div>';
            
            document.getElementById('howToPlayContent').innerHTML = html;
        }

        function showGlossary() {
            document.getElementById('glossaryModal').classList.add('active');
        }

        function showHowToPlay() {
            document.getElementById('howToPlayModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ===== ALL 21 CHAPTERS =====

        function getAllChapters(character) {
            return [
                {
                    id: 0,
                    title: "CHAPTER 1: THE CORONATION",
                    location: "AYODHYA PALACE",
                    verse: {sanskrit: "रामो विग्रहवान् धर्मः", translation: "Rama is dharma incarnate"},
                    text: "King Dasharatha announces Rama's coronation. The city celebrates!",
                    choices: [
                        {text: "Approach with humility", effects: {energy: -5, favor: 10, tapas: 5, sattva: 2, truth: 1, duty: 2}, outcome: "Your humble acceptance brings joy."},
                        {text: "Express concern for brothers", effects: {energy: -5, favor: 5, tapas: 3, sattva: 1, compassion: 2, wisdom: 1}, outcome: "Your compassion is noted."},
                        {text: "Request spiritual preparation", effects: {energy: -10, favor: 8, tapas: 8, sattva: 3, wisdom: 2, selfControl: 1}, outcome: "Spiritual grounding shows wisdom.", sageLesson: "Foundation of Leadership"}
                    ]
                },
                {
                    id: 1,
                    title: "CHAPTER 2: KAIKEYI'S DEMAND",
                    location: "QUEEN'S CHAMBERS",
                    verse: {sanskrit: "धर्मात्मा सत्यसन्धश्च", translation: "Devoted to dharma and truth"},
                    text: "Kaikeyi demands: 'Exile Rama for 14 years, crown Bharata instead!'",
                    choices: [
                        {text: "Accept exile to honor father's promise", effects: {energy: -20, favor: 20, tapas: 15, sattva: 5, truth: 3, duty: 3, selfControl: 2}, outcome: "'A promise must be kept. I shall leave at dawn.'"},
                        {text: "Challenge the unjust demand", effects: {energy: -10, favor: -15, rajas: 3, tamas: 1}, outcome: "Dharma demands keeping promises.", failure: true},
                        {text: "Seek counsel from Sage Vasishtha", effects: {energy: -15, favor: 10, tapas: 10, sattva: 2, wisdom: 3, duty: 1}, outcome: "Vasishtha: 'Your father's word is sacred.'", sageLesson: "Sacred Promises"}
                    ]
                },
                {
                    id: 2,
                    title: "CHAPTER 3: INTO THE FOREST",
                    location: "DANDAKA FOREST",
                    verse: {sanskrit: "तपस्विभिर्महाभागैः", translation: "With great sages"},
                    text: "Enter Dandaka forest. Sage Bharadvaja offers shelter.",
                    choices: [
                        {text: "Accept hospitality and learn", effects: {energy: 10, favor: 15, tapas: 20, sattva: 3, wisdom: 4, duty: 2}, outcome: "Bharadvaja: 'Exile is preparation.'", sageLesson: "Forest Wisdom"},
                        {text: "Press on quickly", effects: {energy: -10, favor: 5, rajas: 2, duty: 1}, outcome: "The sage warns of dangers ahead."},
                        {text: "Ask about establishing hermitage", effects: {energy: -5, favor: 10, tapas: 15, sattva: 2, wisdom: 3}, outcome: "He guides you to Chitrakuta."}
                    ]
                },
                {
                    id: 3,
                    title: "CHAPTER 4: VISHWAMITRA'S WEAPONS",
                    location: "CHITRAKUTA HERMITAGE",
                    verse: {sanskrit: "अस्त्रवर्षं प्रयच्छामि", translation: "I grant you divine weapons"},
                    text: "Vishwamitra: 'I see great battles ahead. Prove your discipline.'",
                    sageTeaching: {sage: "Sage Vishwamitra", lesson: "Divine weapons require perfect spiritual alignment."},
                    choices: [
                        {text: "Undergo 40 days meditation/fasting", effects: {energy: -30, favor: 25, tapas: 30, sattva: 5, wisdom: 4, selfControl: 4}, outcome: "He teaches Brahmastra and Narayana Astra.", weapons: ['Brahmastra', 'Narayana Astra'], sageLesson: "Supreme Discipline"},
                        {text: "Learn basic astras while protecting family", effects: {energy: -15, favor: 10, tapas: 10, rajas: 2, duty: 2}, outcome: "He teaches Agneya and Varunastra.", weapons: ['Agneya', 'Varunastra']},
                        {text: "Learn healing/protective astras first", effects: {energy: -10, favor: 15, tapas: 15, sattva: 3, wisdom: 3, compassion: 3}, outcome: "'Wise choice. Protect before destroying.'", weapons: ['Sanjeevani', 'Twashtar'], sageLesson: "Protection Before Power"}
                    ]
                },
                {
                    id: 4,
                    title: "CHAPTER 5: SURPANAKHA",
                    location: "PANCHAVATI HERMITAGE",
                    verse: {sanskrit: "विरूपां कुरु मां भार्या", translation: "Make me your wife"},
                    text: "Surpanakha approaches in disguise. When refused, she threatens Sita.",
                    choices: [
                        {text: "Firmly reject and protect Sita", effects: {energy: -10, favor: 10, sattva: 2, duty: 2, selfControl: 2}, outcome: "Lakshmana disfigures the demon. She flees screaming revenge."},
                        {text: "Allow Lakshmana to punish aggression", effects: {energy: -5, favor: 5, rajas: 3, tamas: 1, courage: 1}, outcome: "Lakshmana acts swiftly."},
                        {text: "Try to teach her dharma", effects: {energy: -15, favor: 5, tapas: 5, sattva: 2, wisdom: 2, compassion: 2}, outcome: "Your teaching enrages her. Violence cannot always be avoided."}
                    ]
                },
                {
                    id: 5,
                    title: "CHAPTER 6: THE GOLDEN DEER",
                    location: "PANCHAVATI FOREST",
                    verse: {sanskrit: "मायामृगं तं मत्वा तु", translation: "That illusory deer"},
                    text: "Maricha becomes a golden deer. Sita: 'Please catch it!' Lakshmana suspects maya.",
                    choices: [
                        {text: "Trust Lakshmana's wisdom, refuse", effects: {energy: 5, favor: 15, tapas: 10, sattva: 3, wisdom: 4, selfControl: 3}, outcome: "Your wisdom prevents Ravana's trap.", requiresLesson: "Forest Wisdom"},
                        {text: "Chase deer, leave Lakshmana guarding", effects: {energy: -20, favor: 5, rajas: 3, compassion: 1}, outcome: "You pursue. Maricha's dying cry draws Lakshmana away..."},
                        {text: "Investigate carefully first", effects: {energy: -10, favor: 10, tapas: 5, sattva: 2, wisdom: 3}, outcome: "You notice unnatural behavior. 'This is maya.'", requiresLesson: "Forest Wisdom"}
                    ]
                },
                {
                    id: 6,
                    title: "CHAPTER 7: KHAR AND DUSHAN",
                    location: "JANASTHANA",
                    verse: {sanskrit: "मायामयं महाघोरं", translation: "Battle filled with illusions"},
                    text: "Surpanakha brings Khar and Dushan who attack with maya - creating illusions.",
                    sageTeaching: {sage: "Teaching on Maya", lesson: "Only dharma-grounded warriors pierce illusion."},
                    battle: {enemy: "Khar and Dushan", enemyHealth: 180, enemyPower: 30, characterRestriction: ['rama']}
                },
                {
                    id: 7,
                    title: "CHAPTER 8: THE 14,000",
                    location: "JANASTHANA BATTLEFIELD",
                    verse: {sanskrit: "एकोऽहं च चतुर्दश सहस्राणि", translation: "I alone slew fourteen thousand"},
                    text: "Khara leads 14,000 demons. This legendary battle will prove your divinity.",
                    battle: {enemy: "Khara and the 14,000", enemyHealth: 200, enemyPower: 35, characterRestriction: ['rama']}
                },
                {
                    id: 8,
                    title: "CHAPTER 9: SITA'S ABDUCTION",
                    location: "PANCHAVATI - DEVASTATED",
                    verse: {sanskrit: "सीतां दृष्ट्वा तु वैदेहीं हृतां", translation: "Seeing Sita abducted"},
                    text: "Ravana abducts Sita. Jatayu lies mortally wounded, having fought to protect her.",
                    choices: [
                        {text: "Grieve and perform last rites", effects: {energy: -15, favor: 15, tapas: 10, sattva: 3, compassion: 3, duty: 2}, outcome: "Jatayu: 'Ravana... took Sita... south to Lanka... seek Sugriva...'"},
                        {text: "Chase southward in rage", effects: {energy: -25, favor: -5, rajas: 5, tamas: 2}, outcome: "Rage clouds judgment. You lose the trail.", failure: true},
                        {text: "Seek divine guidance through meditation", effects: {energy: -10, favor: 20, tapas: 15, sattva: 4, wisdom: 3}, outcome: "Divine vision shows the path to allies."}
                    ]
                },
                {
                    id: 9,
                    title: "CHAPTER 10: MEETING HANUMAN",
                    location: "RISHYAMUKHA MOUNTAIN",
                    verse: {sanskrit: "हनुमानुपजगाम", translation: "Hanuman approached"},
                    text: "Hanuman approaches in brahmin form. 'Who are you? Why do you seek Sugriva?'",
                    choices: [
                        {text: "Share truth openly", effects: {energy: -5, favor: 20, sattva: 3, truth: 3, wisdom: 2}, outcome: "Hanuman reveals himself! 'Jai Shri Ram! I am your eternal servant!'"},
                        {text: "Test his intentions first", effects: {energy: -10, favor: 10, rajas: 2, wisdom: 2}, outcome: "Hanuman smiles: 'Wise caution, but I am your friend.'"},
                        {text: "Ask about local politics", effects: {energy: -5, favor: 10, wisdom: 2}, outcome: "He explains Sugriva's exile by Vali."}
                    ]
                },
                {
                    id: 10,
                    title: "CHAPTER 11: ALLIANCE WITH SUGRIVA",
                    location: "RISHYAMUKHA MOUNTAIN",
                    verse: {sanskrit: "मित्रं भव", translation: "Be my friend"},
                    text: "Sugriva: 'Help me defeat Vali, I'll help find Sita.' The sacred fire witnesses your oath.",
                    choices: [
                        {text: "Make sacred alliance immediately", effects: {energy: -10, favor: 20, tapas: 15, sattva: 3, duty: 3, truth: 2}, outcome: "Alliance sealed! Sugriva pledges his army."},
                        {text: "Negotiate terms carefully", effects: {energy: -15, favor: 10, rajas: 2, wisdom: 3}, outcome: "Terms agreed. Mutual benefit."},
                        {text: "Ask Hanuman to mediate", effects: {energy: -5, favor: 15, wisdom: 2, compassion: 2}, outcome: "Hanuman ensures fair terms."}
                    ]
                },
                {
                    id: 11,
                    title: "CHAPTER 12: VALI'S DEATH",
                    location: "KISHKINDHA KINGDOM",
                    verse: {sanskrit: "बाणेन निहतो वाली", translation: "Vali slain by arrow"},
                    text: "The battle with Vali. You must shoot from hiding to ensure Sugriva's victory.",
                    battle: {enemy: "Vali", enemyHealth: 190, enemyPower: 40, characterRestriction: ['rama']}
                },
                {
                    id: 12,
                    title: "CHAPTER 13: HANUMAN'S JOURNEY",
                    location: "SOUTHERN SHORE",
                    verse: {sanskrit: "अथ हनुमान् समुद्रं लङ्घयिष्यति", translation: "Then Hanuman will leap the ocean"},
                    text: "Hanuman prepares to leap to Lanka. 'I will find Sita or die trying!'",
                    choices: [
                        {text: "Bless him with divine grace", effects: {energy: -10, favor: 15, tapas: 20, sattva: 3, compassion: 3}, outcome: "Your blessing fills him with limitless power!"},
                        {text: "Give practical advice", effects: {energy: -5, favor: 10, wisdom: 2}, outcome: "'Be cautious but courageous.'"},
                        {text: "Offer signet ring as proof", effects: {energy: -5, favor: 15, duty: 2, wisdom: 2}, outcome: "'Show this to Sita. She will trust you.'"}
                    ]
                },
                {
                    id: 13,
                    title: "CHAPTER 14: BRIDGE TO LANKA",
                    location: "RAMESHWARAM",
                    verse: {sanskrit: "सेतुबन्धनं महत्", translation: "Great bridge construction"},
                    text: "The vanara army builds a bridge to Lanka. Nala and Nila engineer this marvel.",
                    choices: [
                        {text: "Worship Shiva before battle", effects: {energy: -15, favor: 25, tapas: 20, sattva: 4, duty: 3}, outcome: "Shiva blesses the mission. The jyotirlinga marks this sacred spot."},
                        {text: "Focus on bridge construction", effects: {energy: -20, favor: 10, rajas: 3, duty: 2}, outcome: "The bridge rises rapidly!"},
                        {text: "Scout Lanka's defenses", effects: {energy: -10, favor: 10, wisdom: 3, courage: 2}, outcome: "Intelligence gathered on Ravana's fortress."}
                    ]
                },
                {
                    id: 14,
                    title: "CHAPTER 15: VIBHISHANA'S DEFECTION",
                    location: "LANKA SHORES",
                    verse: {sanskrit: "विभीषणो धर्मात्मा", translation: "Righteous Vibhishana"},
                    text: "Vibhishana, Ravana's brother, defects: 'I cannot support adharma any longer!'",
                    choices: [
                        {text: "Welcome him with full trust", effects: {energy: -5, favor: 20, sattva: 3, truth: 2, compassion: 3}, outcome: "Vibhishana becomes invaluable advisor!", sageLesson: "Trust in Dharma"},
                        {text: "Accept but remain cautious", effects: {energy: -10, favor: 10, wisdom: 3}, outcome: "Wise caution. He proves his loyalty."},
                        {text: "Test his loyalty first", effects: {energy: -15, favor: 5, rajas: 2, wisdom: 2}, outcome: "Tests passed. He's genuine."}
                    ]
                },
                {
                    id: 15,
                    title: "CHAPTER 16: KUMBHAKARNA AWAKENS",
                    location: "LANKA BATTLEFIELD",
                    verse: {sanskrit: "कुम्भकर्णो महाबली", translation: "Mighty Kumbhakarna"},
                    text: "Kumbhakarna, Ravana's giant brother, awakens from six-month sleep for battle.",
                    battle: {enemy: "Kumbhakarna", enemyHealth: 220, enemyPower: 45, characterRestriction: ['rama']}
                },
                {
                    id: 16,
                    title: "CHAPTER 17: INDRAJIT'S DECEPTION",
                    location: "LANKA BATTLEFIELD",
                    verse: {sanskrit: "इन्द्रजिन्नागपाशेन", translation: "Indrajit with serpent weapon"},
                    text: "Indrajit (Meghnad), master of maya, attacks. Historically, ONLY LAKSHMANA fights him!",
                    battle: {enemy: "Indrajit", enemyHealth: 200, enemyPower: 42, characterRestriction: ['lakshmana']}
                },
                {
                    id: 17,
                    title: "CHAPTER 18: RAVANA'S FINAL STAND",
                    location: "LANKA THRONE HALL",
                    verse: {sanskrit: "रावणो दशकण्ठः", translation: "Ten-headed Ravana"},
                    text: "The final battle. Ravana, the ten-headed demon king, with all his power.",
                    battle: {enemy: "Ravana", enemyHealth: 250, enemyPower: 50, characterRestriction: ['rama']}
                },
                {
                    id: 18,
                    title: "CHAPTER 19: SITA'S AGNI PARIKSHA",
                    location: "LANKA PALACE",
                    verse: {sanskrit: "अग्निपरीक्षा शुद्धात्मा", translation: "Fire test of pure soul"},
                    text: "Society demands Sita prove her purity through fire ordeal. What do you do?",
                    choices: [
                        {text: "Trust Sita completely, refuse the test", effects: {energy: -10, favor: 25, sattva: 5, truth: 4, compassion: 4}, outcome: "But dharma requires proving innocence. Sita volunteers to clear all doubt."},
                        {text: "Allow test to satisfy society", effects: {energy: -15, favor: 15, rajas: 3, duty: 3}, outcome: "Agni himself brings Sita forth unharmed. All doubts vanish."},
                        {text: "Consult with sages first", effects: {energy: -10, favor: 20, wisdom: 4, duty: 2}, outcome: "Sages agree the test is necessary for rajdharma."}
                    ]
                },
                {
                    id: 19,
                    title: "CHAPTER 20: RETURN TO AYODHYA",
                    location: "AYODHYA PALACE",
                    verse: {sanskrit: "पुनरायोध्यां गमनं", translation: "Return to Ayodhya"},
                    text: "The Pushpaka vimana brings you home. Bharata has ruled as regent, awaiting your return.",
                    choices: [
                        {text: "Honor Bharata's sacrifice publicly", effects: {energy: -5, favor: 25, sattva: 4, compassion: 3, duty: 3}, outcome: "Bharata: 'These sandals have ruled. Now their master returns!' Tears flow."},
                        {text: "Embrace Bharata immediately", effects: {energy: -5, favor: 20, compassion: 4}, outcome: "Brother reunites with brother. The kingdom celebrates!"},
                        {text: "Perform thanksgiving yajna first", effects: {energy: -10, favor: 25, tapas: 15, sattva: 4, duty: 3}, outcome: "Gratitude to the gods who made this possible."}
                    ]
                },
                {
                    id: 20,
                    title: "CHAPTER 21: RAM RAJYA",
                    location: "AYODHYA - THE GOLDEN AGE",
                    verse: {sanskrit: "रामराज्यं सुखदं प्रजानां", translation: "Ram Rajya brings happiness to all"},
                    text: "You rule with perfect dharma. This is the golden age - no crime, no suffering, perfect righteousness. Your dharma has not just saved a kingdom but established an ideal civilization that will inspire generations for thousands of years. This is the true victory - not over Ravana, but over adharma itself.",
                    choices: [
                        {text: "Continue...", effects: {favor: 50, sattva: 10}, outcome: "॥ जय श्री राम ॥ You have completed the eternal story. May these lessons guide your own dharmic path. Remember: dharma may be tested, but it always triumphs. The path of righteousness is the path of true victory."}
                    ]
                }
            ];
        }

        // ===== INIT =====
        window.onload = init;
    </script>
</body>
</html>
